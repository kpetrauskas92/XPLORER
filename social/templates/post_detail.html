{% extends 'base_grid.html' %}
{% load crispy_forms_tags %}
{% load static %}

{% block grid_content %}

    <!-- Back Button Row -->
    <div class="mt-4">
        <a href="{% url 'post-list' %}">
        <button class="btn btn-dark w-100" aria-label="Add a new post">
            <i class="fa-regular fa-circle-left" style="color: white;"></i> Back to Feed
        </button>
        </a>
    </div>

    <!-- Post Display Section -->
    <div class="mt-3">
        <div class="border-bottom post-container">
            <div class="d-flex justify-content-between align-items-center">
                <div class="d-flex align-items-center">
                    <a href="{% url 'profile' post.author.profile.pk %}">
                        <img class=" rounded-circle post-img mr-2" height="40" width="40" src="{{ post.author.profile.picture.url }}"/>
                    </a>
                    <p class="post-text mb-0">
                        <a class="text-primary" href="{% url 'profile' post.author.profile.pk %}">{{ post.author }}</a>
                        {{ post.created_on }}
                    </p>
                </div>
                {% if request.user == post.author %}
                    <div>
                        <a href="{% url 'post-edit' post.pk %}" class="edit-color mr-2"><i class="far fa-edit"></i></a>
                        <a href="{% url 'post-delete' post.pk %}" class="edit-color"><i class="fas fa-trash"></i></a>
                    </div>
                {% endif %}
            </div>

            {% if post.image %}
                <img src="{{ post.image.url }}" class="post-image img-fluid mt-3"/>
            {% endif %}    
            <p>{{ post.body }}</p>
            <div class="d-flex flex-row">

                <!-- Likes button -->
                <form method="POST" action="{% url 'like' post.pk %}" class="mr-2">
                    {% csrf_token %}
                    <input type="hidden" name="next" value="{{ request.path }}">
                    <button class="remove-default-btn" type="submit">
                        <i class="far fa-regular fa-heart"> <span>{{ post.likes.all.count }}</span></i>
                    </button>
                </form>
            </div>
        </div>
    </div>

        <!-- Comment Input Section -->
        <div class="mt-3 mb-5">
            <form method="POST">
                    {% csrf_token %}
                    {{ form | crispy }}
                    <div class="d-grid gap-2">
                        <button class="btn btn-success mt-3">Comment</button>
                    </div>
            </form> 

        <!-- Comments -->
        {% for comment in comments %}
            {% if comment.is_parent %}
                <div class="mt-3 mb-5">
                    <div class="border-bottom post-container">
                        <!-- Comment author, date, and delete link -->
                        <div class="d-flex justify-content-between align-items-center">
                            <div class="d-flex align-items-center">
                                <a href="{% url 'profile' comment.author.profile.pk %}">
                                    <img class="rounded-circle post-img mr-2" height="30" width="30" src="{{ comment.author.profile.picture.url }}"/>
                                </a>
                                <p class="post-text mb-0">
                                    <a class="text-primary post-link" href="{% url 'profile' comment.author.profile.pk %}">{{ comment.author }}</a>
                                    {{ comment.created_on }}
                                </p>
                            </div>
                            {% if request.user == comment.author %}
                                <a href="{% url 'comment-delete' post.pk comment.pk %}" class="edit-color"><i class="fas fa-trash"></i></a>
                            {% endif %}
                        </div>

                        <!-- Comment body -->
                        <p>{{ comment.comment }}</p>
                        <div class="d-flex flex-row">
                            <!-- Likes button -->
                            <form method="POST" action="{% url 'comment-like' post.pk comment.pk %}" class="mr-2">
                                {% csrf_token %}
                                <input type="hidden" name="next" value="{{ request.path }}">
                                <button class="remove-default-btn" type="submit">
                                    <i class="far fa-regular fa-heart"> <span>{{ comment.likes.all.count }}</span></i>
                                </button>
                            </form>
                            
                            <!-- Reply button -->
                            <button class="remove-default-btn" onclick="commentReplyToggle('{{comment.pk}}')">
                                <i class="far fa-comment-dots"></i>
                            </button>
                        </div>
                    </div>
                </div>
                <div class="mt-3 mb-5 d-none" id="{{ comment.pk }}">
            
                        <form method="POST" action="{% url 'comment-reply' post.pk comment.pk %}">
                            {% csrf_token %}
                            {{ form | crispy }}
                            <div class="d-grid gap-2">
                                <button class="btn btn-success mt-3">Comment</button>
                            </div>
                        </form> 

                    <!-- Child Comments -->
                    {% for child_comment in comment.children %}
                        <div class="mt-3 mb-5 child-comment">
                            <div class="border-bottom">
                                <!-- Child comment author, date, and delete link -->
                                <div class="d-flex justify-content-between align-items-center">
                                    <div class="d-flex align-items-center">
                                        <a href="{% url 'profile' child_comment.author.profile.pk %}">
                                            <img class="rounded-circle post-img mr-2" height="30" width="30" src="{{ child_comment.author.profile.picture.url }}"/>
                                        </a>
                                        <p class="post-text mb-0">
                                            <a class="text-primary post-link" href="{% url 'profile' comment.author.profile.pk %}">{{ child_comment.author }}</a>
                                            {{ child_comment.created_on }}
                                        </p>
                                    </div>
                                    {% if request.user == child_comment.author %}
                                        <a href="{% url 'comment-delete' post.pk child_comment.pk %}" class="edit-color"><i class="fas fa-trash"></i></a>
                                    {% endif %}
                                </div>

                                <!-- Child comment body -->
                                <p>{{ child_comment.comment }}</p>
                            </div>
                        </div>
                    {% endfor %}
                {% endif %}
            {% endfor %}
    </div>
<script type="text/javascript" src="{% static 'js/script.js' %}"></script>
{% endblock grid_content %}
